#!/bin/bash
#------------------------------
# PrintDCP v1.01
#------------------------------
# GNU GPLv3
# (c)2018 Jeff Billings
#------------------------------

help () {
  echo "printDCP - automates the process of creating DCP drives"
  echo " "
  echo "Usage: printDCP -g"
  echo "Usage: printDCP -i \"[volume name]\" [drive device path]"
  echo "Usage: printDCP -p [source path] [destination path]"
  echo " "
  echo "  -i --init  Initialize DCP Drive"
  echo "  -c --copy  Copy DCP to Drive"
  echo "  -g --gui   Launch Graphical Interface"
}
cancel () {
  echo "(Cancelled by user)"
  exit 1
}
error () {
  echo "(Error) "$1
  exit 1
}
check () {
  if [[ $? -eq 1 ]]; then
    cancel
  fi
}
finish () {
  echo "(Finished)"
  exit 0
}
init () {
  sudo umount $2
  sudo mkfs.ext3 -I 128 -F -L $1 $2
  sudo mkdir /media/$USER/$1
  sudo mount $2 /media/$USER/$1 
}
copy () {
  rsync -ah --progress --chmod 755 $1 $2
}
gui () {
  intro=$(zenity --info \
    --title="[PrintDCP] Initialize DCP Drive" \
    --width=300 --height=100 \
    --text="Please insert a drive to be <b>erased</b> and formatted." \
    2>/dev/null
  )
  check
  IFS=$'\n'
  drive=$(lsblk -I 8 -d -n -p -P --output NAME,MODEL,SIZE | 
    awk -F '"' '{print $2"\n"$4"\n"$6}' |
    zenity --list --title "[PrintDCP] Initialize DCP Drive" \
    --width 400 --height 300 \
    --text "Select drive to <b>erase</b> and format:" \
    --column "Device" --column "Model" --column "Size" \
    2>/dev/null )
  check
  name=$(zenity --entry --title "[PrintDCP] Drive Name" --text "Enter a drive name:\n(Up to 20 characters)" --entry-text="DCP001" 2>/dev/null)
  check
  echo "(Initializing DCP Drive ...)"
  sudo mkfs.ext3 -I 128 -L $name $drive & PIPED_PID=$!
  tail -f /dev/null --pid $PIPED_PID | (
    zenity --progress --pulsate \
    --width=300 --height=200 \
    --title="[PrintDCP]" \
    --text="Initializing drive..." 2>/dev/null || kill $PIPED_PID );
  check
  intro=$(zenity --info \
    --title="[PrintDCP] Copy DCP to Drive" \
    --width=300 --height=100 \
    --text="Please mount the source media and destination drive at this time." \
    2>/dev/null
  )
  check
   source=$(zenity --file-selection --directory \
    --title="[PrintDCP] Choose source DCP folder ..." \
    --filename=$HOME/ \
    2>/dev/null
  )
  check
  destination=$(zenity --file-selection --directory \
    --title="[PrintDCP] Choose destination drive (root) ..." \
    --filename=$HOME/ \
    2>/dev/null
  )
  check
  echo "(Copying DCP Folder ...)"
  rsync -ah --progress --chmod 755 $source $destination & PIPED_PID=$!
  tail -f /dev/null --pid $PIPED_PID | (
    zenity --progress --pulsate \
    --width=300 --height=200 \
    --title="[PrintDCP]" \
    --text="Copying DCP..." 2>/dev/null || kill $PIPED_PID );
  exit 0
}
if [ "$#" -eq 0 ]; then usage; fi
while [[ "$#" > 0 ]]; do case $1 in
  -i|--init)
    if [ -n "$2" ] && [ -n "$3" ]; then 
      init $2 $3; finish
    else
      error "Missing arguments"; fi
    shift;;
  -c|--copy)
    if [ -n "$2" ] && [ -n "$3" ]; then 
      copy $2 $3; finish
    else
      error "Missing arguments"; fi
    finish
    shift;;
  -g|--gui)
    gui
    finish
    shift;;
  -h|--help|*)
    help
    exit 1;;
esac; shift; done
